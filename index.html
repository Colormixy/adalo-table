// src/Table.js
import React, { useEffect, useMemo, useRef, useState } from "react";
import { View, Text, StyleSheet, Image } from "react-native";

/* A->0, B->1, ..., AA->26 */
function colLetterToIndex(col) {
  let n = 0;
  (col || "")
    .toUpperCase()
    .split("")
    .forEach((ch) => {
      const code = ch.charCodeAt(0);
      if (code >= 65 && code <= 90) n = n * 26 + (code - 64);
    });
  return Math.max(0, n - 1);
}
/* "E2" => { r:1, c:4 } zero-based */
function parseCellRef(ref) {
  const m = (ref || "").match(/^([A-Za-z]+)(\d+)$/);
  if (!m) return { r: 0, c: 0 };
  return { r: Math.max(0, parseInt(m[2], 10) - 1), c: colLetterToIndex(m[1]) };
}
/* dd.mm.yy Europe/Kyiv */
function kyivDateDDMMYY() {
  try {
    const fmt = new Intl.DateTimeFormat("uk-UA", {
      timeZone: "Europe/Kyiv",
      day: "2-digit",
      month: "2-digit",
      year: "2-digit",
    });
    return fmt.format(new Date());
  } catch {
    const d = new Date();
    const dd = String(d.getDate()).padStart(2, "0");
    const mm = String(d.getMonth() + 1).padStart(2, "0");
    const yy = String(d.getFullYear()).slice(-2);
    return `${dd}.${mm}.${yy}`;
  }
}

export default function KyivRateTable(props) {
  const {
    tsvUrl,

    // таблица
    rows = 27,
    cols = 3,
    firstRowHeader = true,

    // ячейки
    rateCell = "E2",
    newsCell = "G2",
    brandsImgCell = "I2",

    // автообновление
    autoRefreshMs = 20000,

    // стили
    accentColor = "#d32f2f",
    borderColor = "#ddd",
    textColor = "#111",
    fontSize = 14,
    rowHeight = 36,
    headerHeight = 40,
    padding = 10,

    // высота изображения брендов (ширина адаптивная)
    brandsImgHeight = 267, // <- как просил, по умолчанию 267
  } = props;

  const [tsvText, setTsvText] = useState("");
  const timerRef = useRef(null);

  async function load() {
    if (!tsvUrl) return;
    try {
      const url =
        tsvUrl + (tsvUrl.includes("?") ? "&" : "?") + "_cb=" + Date.now();
      const res = await fetch(url, { cache: "no-store" });
      const text = await res.text();
      setTsvText(text.trim());
    } catch {}
  }

  useEffect(() => {
    load();
    if (autoRefreshMs > 0) {
      timerRef.current = setInterval(load, autoRefreshMs);
      return () => timerRef.current && clearInterval(timerRef.current);
    }
  }, [tsvUrl, autoRefreshMs]);

  const parsed = useMemo(() => {
    const lines = tsvText ? tsvText.split(/\r?\n/).filter(Boolean) : [];
    const takeRows = Math.min(rows, lines.length);
    const grid = lines
      .slice(0, takeRows)
      .map((ln) => ln.split("\t").slice(0, cols));

    const getCell = (ref) => {
      const { r, c } = parseCellRef(ref);
      if (!lines[r]) return "";
      const arr = lines[r].split("\t");
      return (arr[c] ?? "").toString().trim();
    };

    return {
      grid,
      rate: getCell(rateCell),
      news: getCell(newsCell),
      brandsUrl: getCell(brandsImgCell),
    };
  }, [tsvText, rows, cols, rateCell, newsCell, brandsImgCell]);

  // высота компонента, чтобы экран Adalo нормально скроллился
  const totalHeight = useMemo(() => {
    const hasHeader = firstRowHeader && parsed.grid.length > 0 ? 1 : 0;
    const dataRows = Math.max(0, parsed.grid.length - hasHeader);
    const tableH = (hasHeader ? headerHeight : 0) + dataRows * rowHeight;

    const heroH = fontSize * 1.6 + fontSize * 2;
    let extra = 0;
    if (parsed.news) extra += fontSize * 3 + 12;
    if (parsed.brandsUrl) extra += brandsImgHeight + (fontSize + 18);

    return padding * 2 + heroH + tableH + extra + 12;
  }, [
    parsed.grid,
    parsed.news,
    parsed.brandsUrl,
    firstRowHeader,
    headerHeight,
    rowHeight,
    fontSize,
    padding,
    brandsImgHeight,
  ]);

  const styles = useMemo(
    () =>
      StyleSheet.create({
        container: { padding, width: "100%" },
        heroWrap: { alignItems: "center", marginBottom: 12 },
        line1: {
          fontWeight: "700",
          fontSize: Math.max(16, fontSize + 8),
          color: accentColor,
          textAlign: "center",
        },
        line2: {
          marginTop: 6,
          fontWeight: "700",
          fontSize: Math.max(18, fontSize + 14),
          color: accentColor,
          textAlign: "center",
        },

        sectionTitle: {
          marginTop: 10,
          marginBottom: 6,
          fontWeight: "700",
          fontSize: fontSize + 2,
          color: textColor,
          textAlign: "left",
        },
        newsBox: {
          marginTop: 6,
          marginBottom: 8,
          paddingVertical: 6,
          paddingHorizontal: 10,
          borderWidth: 1,
          borderColor: borderColor,
          borderRadius: 6,
          backgroundColor: "#fff",
        },
        newsText: {
          color: textColor,
          fontSize,
          lineHeight: Math.round(fontSize * 1.3),
          textAlign: "left",
        },

        table: { borderWidth: 0, width: "100%", marginTop: 8 },
        row: { flexDirection: "row", width: "100%" },
        cell: {
          borderWidth: 1,
          borderColor,
          height: rowHeight,
          justifyContent: "center",
          alignItems: "center",
          paddingHorizontal: 6,
          flex: 1,
        },
        headCell: {
          borderWidth: 1,
          borderColor,
          height: headerHeight,
          justifyContent: "center",
          alignItems: "center",
          paddingHorizontal: 6,
          flex: 1,
          backgroundColor: "#fafafa",
        },
        txt: { color: textColor, fontSize, textAlign: "center" },
        headTxt: {
          color: textColor,
          fontSize,
          fontWeight: "700",
          textAlign: "center",
        },

        brandsWrap: { marginTop: 12, alignItems: "center" },
        brandsTitle: {
          fontWeight: "700",
          color: textColor,
          fontSize: fontSize + 2,
          marginBottom: 8,
          textAlign: "center",
        },
        brandsImg: {
          width: "100%",
          height: brandsImgHeight,
          resizeMode: "contain",
        },

        spacer: { height: 1 },
      }),
    [
      padding,
      fontSize,
      accentColor,
      textColor,
      borderColor,
      rowHeight,
      headerHeight,
      brandsImgHeight,
    ]
  );

  const headerRow =
    firstRowHeader && parsed.grid.length > 0 ? parsed.grid[0] : null;
  const bodyRows =
    firstRowHeader && parsed.grid.length > 1 ? parsed.grid.slice(1) : parsed.grid;

  const hasNews = parsed.news && parsed.news.trim().length > 0;
  const hasBrandImg =
    parsed.brandsUrl && /^https?:\/\//i.test(parsed.brandsUrl.trim());

  return (
    <View style={{ width: "100%", height: totalHeight }}>
      <View style={styles.container}>
        {/* 1) Курс */}
        <View style={styles.heroWrap} pointerEvents="none">
          <Text style={styles.line1}>Курс на {kyivDateDDMMYY()}</Text>
          <Text style={styles.line2}>{parsed.rate ?? "--"}</Text>
        </View>

        {/* 2) Новости (если есть G2) */}
        {hasNews && (
          <View>
            <Text style={styles.sectionTitle}>Новости</Text>
            <View style={styles.newsBox}>
              <Text style={styles.newsText}>{parsed.news}</Text>
            </View>
          </View>
        )}

        {/* 3) Таблица */}
        <View style={styles.table}>
          {headerRow && (
            <View style={styles.row}>
              {headerRow.map((cell, i) => (
                <View key={`h-${i}`} style={styles.headCell}>
                  <Text style={styles.headTxt} numberOfLines={2}>
                    {cell}
                  </Text>
                </View>
              ))}
            </View>
          )}
          {bodyRows.map((r, ri) => (
            <View key={`r-${ri}`} style={styles.row}>
              {r.map((cell, ci) => (
                <View key={`c-${ri}-${ci}`} style={styles.cell}>
                  <Text style={styles.txt} numberOfLines={1}>
                    {cell}
                  </Text>
                </View>
              ))}
            </View>
          ))}
        </View>

        {/* 4) Бренды (если есть URL в I2) */}
        {hasBrandImg && (
          <View style={styles.brandsWrap}>
            <Text style={styles.brandsTitle}>
              Бонус начисляется за следующие бренды:
            </Text>
            <Image source={{ uri: parsed.brandsUrl }} style={styles.brandsImg} />
          </View>
        )}

        <View style={styles.spacer} />
      </View>
    </View>
  );
}
