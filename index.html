<!doctype html>
<html lang="ru">
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Rates + Table (no-inner-scroll)</title>
<style>
  :root { --pad: 10px; --border: 1px solid #ddd; }
  * { box-sizing: border-box; }

  /* Никаких фикс. высот и внутреннего скролла */
  html, body {
    margin: 0;
    height: auto;          /* важно: НЕ 100%, НЕ 100vh */
    min-height: 0;
    overflow: visible;     /* скролл берёт на себя Adalo-screen */
    font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
    background: #fff;
    -webkit-tap-highlight-color: transparent;
    color: #111;
  }

  .wrap { padding: var(--pad); }

  /* Хедер с курсом */
  .hero { text-align: center; margin: 6px 0 12px; line-height: 1.15; user-select: none; -webkit-user-select: none; }
  .hero .line1 { font-weight: 700; font-size: 22px; color: #d32f2f; }
  .hero .line2 { margin-top: 6px; font-weight: 700; font-size: 28px; color: #d32f2f; }

  /* Новости */
  .newsWrap { margin: 10px 0 12px; }
  .newsTitle { font-weight: 700; font-size: 16px; margin: 0 0 6px; }
  .newsBox { border: var(--border); border-radius: 6px; background: #fff; padding: 8px 12px; line-height: 1.3; }

  /* Таблица */
  table { width: 100%; border-collapse: collapse; table-layout: fixed; margin-top: 8px; }
  th, td {
    border: var(--border);
    padding: 8px;
    overflow: hidden;
    text-overflow: ellipsis;
    white-space: nowrap;
    text-align: center;
  }
  thead th {
    background: #fafafa;           /* без sticky, чтобы не ломало скролл */
    white-space: normal;           /* перенос заголовков */
    word-break: break-word;
  }
  tbody tr:nth-child(odd){ background:#fcfcfc; }

  /* Бренды */
  .brands { margin-top: 14px; text-align: center; }
  .brandsTitle { font-weight: 700; font-size: 16px; margin: 0 0 8px; }
  .brands img { width: 100%; max-width: 375px; height: 267px; object-fit: contain; }
</style>

<div class="wrap">
  <!-- Курс -->
  <div class="hero">
    <div class="line1">Курс на <span id="dateKyiv">--.--.--</span></div>
    <div class="line2"><span id="rateValue">--</span></div>
  </div>

  <!-- Новости (появляется, только если в G2 есть текст) -->
  <div id="newsSection" class="newsWrap" style="display:none;">
    <div class="newsTitle">Новости</div>
    <div id="newsText" class="newsBox"></div>
  </div>

  <!-- Таблица -->
  <table id="t"><thead></thead><tbody></tbody></table>

  <!-- Бренды (появляется, только если в I2 валидный URL) -->
  <div id="brandsSection" class="brands" style="display:none;">
    <div class="brandsTitle">Бонус начисляется за следующие бренды:</div>
    <img id="brandsImg" alt="Бренды">
  </div>
</div>

<script>
/* === НАСТРОЙКИ — меняй тут === */
const TSV_URL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vSEFIQibBd7WSJn-PrlsjJvKiTqAW3sUDxJO7s5Aq9woewpqaBBNIrTJvwyaijdJKSN9ULR4jP9I__w/pub?gid=0&single=true&output=tsv";
const ROWS = 27;                    // если USE_FIRST_ROW_AS_HEADER=true, сюда входит строка заголовка
const COLS = 3;
const USE_FIRST_ROW_AS_HEADER = true;
const REFRESH_EVERY_MS = 20000;

/* Курс из E2 */
const RATE_CELL_ROW = 2;            // 1-based
const RATE_CELL_COL = "E";

/* Новости из G2 + картинка брендов из I2 */
const NEWS_CELL_ROW = 2;            // 1-based
const NEWS_CELL_COL = "G";
const BRANDS_CELL_ROW = 2;          // 1-based
const BRANDS_CELL_COL = "I";

/* — служебные — */
(function () {
  const u = new URL(window.location.href);
  u.searchParams.set("v", Date.now().toString());   // кэш-бастинг для самой страницы
  window.history.replaceState({}, "", u.toString());
})();

function colLetterToIndex(col){
  let n = 0;
  for (const ch of col.toUpperCase()){
    const c = ch.charCodeAt(0);
    if (c < 65 || c > 90) continue;
    n = n*26 + (c - 64);
  }
  return n - 1;
}

function kyivDateDDMMYY(){
  try {
    const fmt = new Intl.DateTimeFormat("uk-UA", {
      timeZone: "Europe/Kyiv",
      day: "2-digit", month: "2-digit", year: "2-digit"
    });
    return fmt.format(new Date());
  } catch {
    const d = new Date();
    const dd = String(d.getDate()).padStart(2, "0");
    const mm = String(d.getMonth() + 1).padStart(2, "0");
    const yy = String(d.getFullYear()).slice(-2);
    return `${dd}.${mm}.${yy}`;
  }
}

async function fetchTSV(){
  const url = TSV_URL + (TSV_URL.includes("?") ? "&" : "?") + "_cb=" + Date.now(); // кэш-бастинг для TSV
  const res = await fetch(url, { cache: "no-store" });
  return (await res.text()).trim();
}

function getCellText(lines, row1b, colLetter){
  const r = row1b - 1;
  const c = colLetterToIndex(colLetter);
  if (!lines[r]) return "";
  const cols = lines[r].split("\t");
  return (cols[c] ?? "").toString().trim();
}

function render(text){
  // верхний блок
  document.getElementById("dateKyiv").textContent = kyivDateDDMMYY();

  const allRows = text.split(/\r?\n/).filter(Boolean);

  // 1) курс
  const rate = getCellText(allRows, RATE_CELL_ROW, RATE_CELL_COL);
  document.getElementById("rateValue").textContent = rate || "--";

  // 2) новости (если есть G2)
  const news = getCellText(allRows, NEWS_CELL_ROW, NEWS_CELL_COL);
  const newsSection = document.getElementById("newsSection");
  const newsTextEl = document.getElementById("newsText");
  if (news) {
    newsTextEl.textContent = news;
    newsSection.style.display = "";
  } else {
    newsSection.style.display = "none";
  }

  // 3) таблица
  const takeRows = Math.min(ROWS, allRows.length);
  const rows = allRows.slice(0, takeRows).map(r => r.split("\t").slice(0, COLS));

  const thead = document.querySelector("#t thead");
  const tbody = document.querySelector("#t tbody");
  thead.innerHTML = "";
  tbody.innerHTML = "";

  if (rows.length) {
    if (USE_FIRST_ROW_AS_HEADER){
      const head = rows[0];
      const trH = document.createElement("tr");
      head.forEach(c => { const th = document.createElement("th"); th.textContent = c ?? ""; trH.appendChild(th); });
      thead.appendChild(trH);

      rows.slice(1).forEach(row => {
        const tr = document.createElement("tr");
        for (let i=0;i<COLS;i++){
          const td = document.createElement("td");
          td.textContent = row[i] ?? "";
          tr.appendChild(td);
        }
        tbody.appendChild(tr);
      });
    } else {
      rows.forEach(row => {
        const tr = document.createElement("tr");
        for (let i=0;i<COLS;i++){
          const td = document.createElement("td");
          td.textContent = row[i] ?? "";
          tr.appendChild(td);
        }
        tbody.appendChild(tr);
      });
    }
  }

  // 4) бренды (если I2 — валидный URL)
  const brandsUrl = getCellText(allRows, BRANDS_CELL_ROW, BRANDS_CELL_COL);
  const brandsSection = document.getElementById("brandsSection");
  const brandsImg = document.getElementById("brandsImg");

  function hideBrands(){ brandsSection.style.display = "none"; }

  if (/^https?:\/\//i.test(brandsUrl)) {
    brandsImg.onload = () => { brandsSection.style.display = ""; };
    brandsImg.onerror = hideBrands;
    brandsImg.src = brandsUrl;
  } else {
    hideBrands();
  }
}

async function loadAndRender(){
  try { const t = await fetchTSV(); render(t); }
  catch(e){ console.error("TSV fetch error:", e); }
}

loadAndRender();
setInterval(loadAndRender, REFRESH_EVERY_MS);
/* при возврате на экран/вкладку — подгрузим свежак */
document.addEventListener("visibilitychange", () => { if (!document.hidden) loadAndRender(); });
</script>
</html>
