<!doctype html>
<html lang="ru">
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Adalo Table vURL</title>
<style>
  :root { --pad: 10px; --border: 1px solid #ddd; }
  * { box-sizing: border-box; }
  body { margin:0; font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; background:#fff; }
  .wrap { padding: var(--pad); }
  table { width:100%; border-collapse: collapse; table-layout: fixed; }
  th, td { border: var(--border); padding:8px; overflow:hidden; text-overflow: ellipsis; white-space: nowrap; text-align:center; }
  thead th { position: sticky; top:0; background:#fafafa; white-space: normal; word-break: break-word; text-align:center; }
  tbody tr:nth-child(odd){ background:#fcfcfc; }
  .meta{display:flex;gap:8px;margin:6px 0 10px;align-items:center}
  .cfg{font:12px system-ui;color:#666}
</style>
<div class="wrap">
  <div class="meta">
    <small id="ts" class="cfg"></small>
    <small id="cfg" class="cfg"></small>
  </div>
  <table id="t"><thead></thead><tbody></tbody></table>
</div>
<script>
/* === НАСТРОЙКИ ПО УМОЛЧАНИЮ (можно переопределить через URL) === */
const DEFAULT_TSV_URL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vSEFIQibBd7WSJn-PrlsjJvKiTqAW3sUDxJO7s5Aq9woewpqaBBNIrTJvwyaijdJKSN9ULR4jP9I__w/pub?gid=0&single=true&output=tsv";
const DEFAULT_ROWS = 3;   // если не переданы ?rows и ?cols
const DEFAULT_COLS = 3;
const USE_FIRST_ROW_AS_HEADER = true;
const REFRESH_EVERY_MS = 20000;

/* === Чтение параметров из URL: ?rows=27&cols=3&tsv=<url> === */
const sp = new URLSearchParams(location.search);
let TSV_URL = sp.get("tsv") || DEFAULT_TSV_URL;
let ROWS = Number(sp.get("rows") || DEFAULT_ROWS);
let COLS = Number(sp.get("cols") || DEFAULT_COLS);

/* Ломаем кэш, но СОХРАНЯЕМ существующие параметры (?rows, ?cols, ?tsv) */
(function bustCachePreservingParams(){
  const u = new URL(window.location.href);
  u.searchParams.set("v", Date.now().toString());
  window.history.replaceState({}, "", u.toString());
})();

document.getElementById('cfg').textContent = `ROWS=${ROWS}, COLS=${COLS}`;

async function fetchTSV(){
  const url = TSV_URL + (TSV_URL.includes("?") ? "&" : "?") + "_cb=" + Date.now();
  const res = await fetch(url, { cache: "no-store" });
  return (await res.text()).trim();
}

function render(text){
  const rowsAll = text.split(/\r?\n/).filter(Boolean);
  const takeRows = Math.min(ROWS, rowsAll.length);
  const rows = rowsAll.slice(0, takeRows).map(r => r.split("\t").slice(0, COLS));

  const thead = document.querySelector("#t thead");
  const tbody = document.querySelector("#t tbody");
  thead.innerHTML = "";
  tbody.innerHTML = "";

  if (!rows.length) return;

  if (USE_FIRST_ROW_AS_HEADER){
    const head = rows[0];
    const tr = document.createElement("tr");
    head.forEach(c => { const th = document.createElement("th"); th.textContent = c ?? ""; tr.appendChild(th); });
    thead.appendChild(tr);
    rows.slice(1).forEach(row => {
      const tr = document.createElement("tr");
      for (let i=0;i<COLS;i++){ const td = document.createElement("td"); td.textContent = row[i] ?? ""; tr.appendChild(td); }
      tbody.appendChild(tr);
    });
  } else {
    rows.forEach(row => {
      const tr = document.createElement("tr");
      for (let i=0;i<COLS;i++){ const td = document.createElement("td"); td.textContent = row[i] ?? ""; tr.appendChild(td); }
      tbody.appendChild(tr);
    });
  }
  document.getElementById("ts").textContent = "обновлено: " + new Date().toLocaleTimeString();
}

async function loadAndRender(){
  try { const t = await fetchTSV(); render(t); }
  catch(e){ console.error("TSV fetch error:", e); }
}

loadAndRender();
setInterval(loadAndRender, REFRESH_EVERY_MS);
document.addEventListener("visibilitychange", () => { if (!document.hidden) loadAndRender(); });
</script>
</html>
