<!doctype html>
<html lang="ru">
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Adalo Table</title>
<style>
  :root { --pad: 10px; --border: 1px solid #ddd; }
  * { box-sizing: border-box; }
  body { margin:0; font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; background:#fff; }
  .wrap { padding: var(--pad); }
  table { width:100%; border-collapse: collapse; table-layout: fixed; }
  th, td { border: var(--border); padding:8px; overflow:hidden; text-overflow: ellipsis; white-space: nowrap; text-align:center; }
  thead th { position: sticky; top:0; background:#fafafa; white-space: normal; word-break: break-word; text-align:center; }
  tbody tr:nth-child(odd){ background:#fcfcfc; }
  .bar{display:flex;gap:8px;margin:6px 0 10px}
  .btn{border:1px solid #ddd;padding:6px 10px;border-radius:6px;background:#f7f7f7;cursor:pointer}
</style>
<div class="wrap">
  <div class="bar">
    <button class="btn" id="refreshBtn">Обновить</button>
    <small id="ts"></small>
  </div>
  <table id="t"><thead></thead><tbody></tbody></table>
</div>
<script>
/* === НАСТРОЙКИ === */
const TSV_URL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vSEFIQibBd7WSJn-PrlsjJvKiTqAW3sUDxJO7s5Aq9woewpqaBBNIrTJvwyaijdJKSN9ULR4jP9I__w/pub?gid=0&single=true&output=tsv";
const ROWS = 27;                 // сколько строк показывать (включая заголовок)
const COLS = 3;                 // сколько столбцов показывать
const USE_FIRST_ROW_AS_HEADER = true;
const REFRESH_EVERY_MS = 20000; // авто-обновление (поставь 5000 если надо чаще)

// Ломаем кэш Adalo (страница каждый раз с уникальным query)
(function bustAdaloCache(){
  const p = new URL(window.location.href);
  p.searchParams.set("v", Date.now().toString());
  window.history.replaceState({}, "", p.toString());
})();

async function fetchTSV(){
  const url = TSV_URL + (TSV_URL.includes("?") ? "&" : "?") + "_cb=" + Date.now();
  const res = await fetch(url, { cache: "no-store" });
  return (await res.text()).trim();
}

function render(text){
  const rowsAll = text.split(/\r?\n/).filter(Boolean);
  const rows = rowsAll.slice(0, ROWS).map(r => r.split("\t").slice(0, COLS));

  const thead = document.querySelector("#t thead");
  const tbody = document.querySelector("#t tbody");
  thead.innerHTML = "";
  tbody.innerHTML = "";

  if (!rows.length) return;

  if (USE_FIRST_ROW_AS_HEADER){
    const head = rows[0];
    const tr = document.createElement("tr");
    head.forEach(c => { const th = document.createElement("th"); th.textContent = c ?? ""; tr.appendChild(th); });
    thead.appendChild(tr);
    rows.slice(1).forEach(row => {
      const tr = document.createElement("tr");
      for (let i=0;i<COLS;i++){ const td = document.createElement("td"); td.textContent = row[i] ?? ""; tr.appendChild(td); }
      tbody.appendChild(tr);
    });
  } else {
    rows.forEach(row => {
      const tr = document.createElement("tr");
      for (let i=0;i<COLS;i++){ const td = document.createElement("td"); td.textContent = row[i] ?? ""; tr.appendChild(td); }
      tbody.appendChild(tr);
    });
  }
  document.getElementById("ts").textContent = "обновлено: " + new Date().toLocaleTimeString();
}

async function loadAndRender(){
  try { const t = await fetchTSV(); render(t); }
  catch(e){ console.error("TSV fetch error:", e); }
}

// — стартовая загрузка
loadAndRender();

// — авто-обновление
setInterval(loadAndRender, REFRESH_EVERY_MS);

// — мгновенное обновление, когда экран снова виден (возврат в этот экран в Adalo)
document.addEventListener("visibilitychange", () => {
  if (!document.hidden) loadAndRender();
});

// — ручная кнопка "Обновить"
document.getElementById("refreshBtn").addEventListener("click", loadAndRender);
</script>
</html>
